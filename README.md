# local.chatbot — Локальный провайдер событий для Битрикс24 (коробка)
Модуль для коробочной версии Битрикс24, обеспечивающий прямую доставку событий чат-ботам без использования внешних серверов и без подписки на Маркет.

## Назначение

С ноября 2025 года для работы исходящих событий на коробочных установках Битрикс24 требуется платная подписка на Маркет. Без неё события (в том числе сообщения пользователей чат-ботам) не доставляются на обработчики.

Данный модуль решает эту проблему документированным способом — через механизм [Custom Auth Provider](https://apidocs.bitrix24.ru/settings/cloud-and-on-premise/on-premise/custom-auth-provider.html), предусмотренный архитектурой Битрикс24. Модуль регистрирует собственный провайдер событий, который отправляет HTTP-запросы напрямую на указанный URL обработчика по локальной сети.

## Схема работы

**Стандартная схема (без подписки — не работает):**
Пользователь → Битрикс24 → Внешние сервера → [заблокировано] → Обработчик бота

**С установленным модулем:**
Пользователь → Битрикс24 → Обработчик бота (прямой HTTP POST внутри локальной сети)

## Что делает модуль

- Регистрирует собственный провайдер событий вместо стандартного облачного
- Отправляет события напрямую на URL обработчика бота по локальной сети
- Пробрасывает события для не-локальных URL через стандартный механизм
- Ведёт лог отправок для отладки

## [Структура (Урезаной версии провайдера)](https://github.com/SotnikRoot/your-event-provider-in-Bitrix24/tree/main/local.chatbot_v1.0.1/local.chatbot)
```
local.chatbot/
├── install/
│   ├── index.php         — регистрация модуля и обработчиков событий
│   ├── step.php          — сообщение после установки
│   ├── unstep.php        — сообщение после удаления
│   └── version.php       — версия модуля
├── include.php           — автозагрузка классов
└── lib/
└── EventProvider.php — провайдер: перехват и прямая отправка событий
```

## [Структура (Полной версии провайдера)](https://github.com/SotnikRoot/your-event-provider-in-Bitrix24/tree/main/local.authprovider_v1.0.0/local.authprovider)
```
/local/modules/local.authprovider/
├── install/
│   ├── index.php         — регистрация модуля и обработчиков событий
│   ├── step.php          — сообщение после установки
│   ├── unstep.php        — сообщение после удаления
│   └── version.php       — версия модуля
├── include.php           — автозагрузка классов
└── lib/
    ├── AuthSimple.php    — валидатор авторизации
    ├── EventProvider.php — провайдер: перехват и прямая отправка событий
    └── AuthProvider.php  — провайдер токенов
```

## Требования

- Битрикс24 коробочная версия
- PHP 7.4+
- Установленный и активный модуль `rest` в Битрикс24

## Установка

### 1. Подготовка директории
```bash
mkdir -p /home/bitrix/www/local/modules/      — Создание директории local/modules (она может уже быть если есть другие модули). Учтите, что путь у вас может быть свой.
chmod -R 755 /home/bitrix/www/local/
chown -R bitrix:bitrix /home/bitrix/www/local
cd /home/bitrix/www/local/modules             — Перешли в директорию
```

---Далее сюда всё кладём по структуре---

### 2. Настройка локальных адресов
В файле lib/EventProvider.php укажите адреса серверов, на которые события должны отправляться напрямую:

```php
$localPatterns = array(
    '127.0.0.1',
    'localhost',
    // IP сервера с ботом
    // или доменное имя
);
```

### 3. Установка через админку
Перейдите:
Администрирование → Marketplace → Установленные решения → Доступные решения
Найдите «Локальная отправка сообщений чат-бота (local.chatbot)» и нажмите Установить.
Или откройте напрямую:
```
https://<ваш_сервер>/bitrix/admin/partner_modules.php?lang=ru
```

### 4. Удаление
Администрирование → Marketplace → Установленные решения → найти модуль → Удалить
Модуль корректно снимет регистрацию обработчиков событий.

## Принцип работы
При установке модуль регистрирует обработчик события onEventManagerInitialize модуля rest.
При инициализации менеджера событий вызывается EventProvider::onEventManagerInitialize(), который регистрирует собственный провайдер отправки.
При генерации события (например, новое сообщение боту) вызывается метод send() провайдера.
Провайдер проверяет URL получателя: если адрес входит в список локальных — выполняет прямой HTTP POST через HttpClient; если адрес внешний — передаёт обработку стандартному механизму.

## Ссылки
[Документация Битрикс: Custom Auth Provider](https://apidocs.bitrix24.ru/settings/cloud-and-on-premise/on-premise/custom-auth-provider.html)

[Подробный разбор на Хабре](https://habr.com/ru/articles/1003872/)

## Лицензия
MIT
